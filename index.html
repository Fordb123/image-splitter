<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Divisor de Im√°genes Gratuito Online - M√∫ltiples Fotos, Divisiones Independientes o Globales, Autom√°tico por N√∫mero de Partes</title>
    <meta name="description" content="Divide m√∫ltiples im√°genes online gratis. L√≠neas arrastrables, divisi√≥n autom√°tica por filas/columnas, descarga ZIP. 100% privado, funciona en tu navegador.">
    <meta name="keywords" content="divisor im√°genes, cortar fotos, split image, dividir imagen online, gratis">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://tuusuario.github.io/image-splitter/">
    
    <style>
        /* ========== VARIABLES Y TEMA ========== */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e8e8e8;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --accent: #2563eb;
            --accent-hover: #1d4ed8;
            --danger: #dc2626;
            --success: #16a34a;
            --warning: #f59e0b;
            --border: #d1d5db;
            --shadow: rgba(0,0,0,0.1);
            --line-vertical: rgba(37, 99, 235, 0.9);
            --line-horizontal: rgba(220, 38, 38, 0.9);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #0f0f0f;
                --bg-secondary: #1a1a1a;
                --bg-tertiary: #2a2a2a;
                --text-primary: #f0f0f0;
                --text-secondary: #a0a0a0;
                --border: #404040;
                --shadow: rgba(0,0,0,0.3);
            }
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e8e8e8;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border: #d1d5db;
            --shadow: rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --border: #404040;
            --shadow: rgba(0,0,0,0.3);
        }

        /* ========== RESET Y BASE ========== */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            /* Prevenir scroll horizontal en m√≥vil durante drag */
            overflow-x: hidden;
        }

        /* ========== HEADER ========== */
        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1 {
            font-size: clamp(1rem, 3vw, 1.5rem);
            font-weight: 700;
            color: var(--accent);
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        /* ========== BOTONES ========== */
        button, .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            /* Mejorar touch en m√≥vil */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ========== INPUTS ========== */
        input[type="number"], input[type="text"] {
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.875rem;
            width: 60px;
        }

        input[type="file"] {
            display: none;
        }

        label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* ========== √ÅREA PRINCIPAL ========== */
        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* ========== ZONA DE CARGA ========== */
        .upload-zone {
            border: 3px dashed var(--border);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s;
            margin-bottom: 1.5rem;
            background: var(--bg-secondary);
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--accent);
            background: var(--bg-tertiary);
        }

        .upload-zone h2 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .upload-zone p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .upload-limits {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 1rem;
        }

        /* ========== ALERTAS ========== */
        .alert {
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
        }

        .alert-danger {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .alert-info {
            background: rgba(37, 99, 235, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        /* ========== CONTENEDOR DE IM√ÅGENES ========== */
        #images-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* ========== SECCI√ìN DE IMAGEN INDIVIDUAL ========== */
        .image-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--border);
        }

        .image-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .image-info {
            flex: 1;
            min-width: 200px;
        }

        .image-info h3 {
            font-size: 1rem;
            word-break: break-all;
            margin-bottom: 0.25rem;
        }

        .image-info .dimensions {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .image-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .control-group label {
            white-space: nowrap;
            font-size: 0.75rem;
        }

        /* ========== PREVIEW CONTAINER - CENTRADO ========== */
        .preview-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            background: var(--bg-tertiary);
            margin-bottom: 1rem;
            /* CENTRAR EL CONTENIDO */
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .preview-container {
            position: relative;
            display: inline-block;
            overflow: auto;
            max-height: 600px;
            /* Prevenir selecci√≥n de texto durante drag */
            user-select: none;
            -webkit-user-select: none;
            /* Touch action para mejor control */
            touch-action: none;
        }

        .preview-canvas {
            display: block;
            height: auto;
            /* NO usar cursor crosshair, confunde */
            cursor: default;
        }

        /* ========== L√çNEAS DIVISORAS - MEJORADAS PARA TOUCH ========== */
        .split-line {
            position: absolute;
            z-index: 10;
            /* Transiciones suaves */
            transition: transform 0.1s ease-out;
        }

        .split-line.vertical {
            width: 4px;
            height: 100%;
            top: 0;
            cursor: ew-resize;
            background: var(--line-vertical);
            /* √Årea de toque m√°s grande en m√≥vil */
            touch-action: none;
        }

        .split-line.horizontal {
            height: 4px;
            width: 100%;
            left: 0;
            cursor: ns-resize;
            background: var(--line-horizontal);
            touch-action: none;
        }

        /* √Årea de toque expandida para m√≥vil */
        .split-line::before {
            content: '';
            position: absolute;
            z-index: -1;
        }

        .split-line.vertical::before {
            top: 0;
            bottom: 0;
            left: -15px;
            right: -15px;
        }

        .split-line.horizontal::before {
            left: 0;
            right: 0;
            top: -15px;
            bottom: -15px;
        }

        .split-line:hover, .split-line.dragging {
            filter: brightness(1.3);
            transform: scale(1.1);
        }

        .split-line.vertical:hover, .split-line.vertical.dragging {
            width: 6px;
            margin-left: -1px;
        }

        .split-line.horizontal:hover, .split-line.horizontal.dragging {
            height: 6px;
            margin-top: -1px;
        }

        /* Bot√≥n de eliminar l√≠nea */
        .line-delete-btn {
            position: absolute;
            background: rgba(220, 38, 38, 0.9);
            color: white;
            font-size: 12px;
            font-weight: bold;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            border: 2px solid white;
            z-index: 15;
            /* Touch friendly */
            touch-action: manipulation;
        }

        .split-line:hover .line-delete-btn,
        .split-line.dragging .line-delete-btn,
        .split-line:active .line-delete-btn {
            opacity: 1;
        }

        /* Siempre visible en m√≥vil */
        @media (max-width: 768px) {
            .line-delete-btn {
                opacity: 1;
                width: 28px;
                height: 28px;
                font-size: 14px;
            }
        }

        .split-line.vertical .line-delete-btn {
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
        }

        .split-line.horizontal .line-delete-btn {
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* ========== THUMBNAILS DE PARTES ========== */
        .parts-preview {
            margin-top: 1rem;
        }

        .parts-preview h4 {
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .parts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .part-thumbnail {
            position: relative;
            aspect-ratio: 1;
            overflow: hidden;
            border-radius: 4px;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }

        .part-thumbnail:hover {
            transform: scale(1.05);
            z-index: 5;
            border-color: var(--accent);
        }

        .part-thumbnail canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: var(--bg-primary);
        }

        .part-thumbnail .part-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            font-size: 0.625rem;
            padding: 2px 4px;
            text-align: center;
        }

        .part-thumbnail .download-part {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 3px;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .part-thumbnail:hover .download-part {
            opacity: 1;
        }

        /* ========== ACCIONES DE IMAGEN ========== */
        .image-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        /* ========== HISTORIAL UNDO/REDO ========== */
        .history-controls {
            display: flex;
            gap: 0.25rem;
        }

        /* ========== MODAL TUTORIAL ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal {
            background: var(--bg-primary);
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
        }

        .modal h2 {
            margin-bottom: 1rem;
            color: var(--accent);
        }

        .modal h3 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .modal p, .modal li {
            margin-bottom: 0.75rem;
            color: var(--text-secondary);
        }

        .modal ul {
            padding-left: 1.5rem;
        }

        .modal .close-btn {
            margin-top: 1.5rem;
            width: 100%;
        }

        /* ========== SPINNER/PROGRESO ========== */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            color: white;
            z-index: 20;
        }

        .progress-overlay.hidden {
            display: none;
        }

        /* ========== TEMA TOGGLE ========== */
        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 0.25rem;
            display: flex;
            gap: 0.25rem;
        }

        .theme-toggle button {
            padding: 0.25rem 0.5rem;
            border-radius: 16px;
            font-size: 0.75rem;
        }

        .theme-toggle button.active {
            background: var(--accent);
            color: white;
        }

        /* ========== ZOOM CONTROLS ========== */
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--bg-tertiary);
            padding: 0.25rem;
            border-radius: 6px;
        }

        .zoom-level {
            font-size: 0.75rem;
            min-width: 40px;
            text-align: center;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .image-controls {
                justify-content: center;
            }

            .parts-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }

            .control-group label {
                font-size: 0.65rem;
            }

            input[type="number"] {
                width: 50px;
                padding: 0.3rem 0.4rem;
            }

            .preview-container {
                max-height: 400px;
            }
        }

        /* ========== FOOTER ========== */
        footer {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-secondary);
            font-size: 0.75rem;
            border-top: 1px solid var(--border);
            margin-top: 2rem;
        }

        /* ========== GLOBAL CONTROLS BAR ========== */
        .global-controls {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            justify-content: space-between;
        }

        .global-controls.hidden {
            display: none;
        }

        .global-left {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .global-right {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        /* Indicador visual de l√≠nea activa */
        .split-line.active {
            z-index: 100;
        }
    </style>
</head>
<body>
    <!-- ========== HEADER ========== -->
    <header>
        <div class="header-content">
            <h1>‚úÇÔ∏è Divisor de Im√°genes Online</h1>
            <div class="header-actions">
                <button class="btn btn-secondary btn-small" id="helpBtn" title="Ayuda">‚ùì Ayuda</button>
                <div class="theme-toggle">
                    <button id="themeAuto" class="active" title="Autom√°tico">Auto</button>
                    <button id="themeLight" title="Claro">‚òÄÔ∏è</button>
                    <button id="themeDark" title="Oscuro">üåô</button>
                </div>
            </div>
        </div>
    </header>

    <!-- ========== MAIN ========== -->
    <main>
        <!-- Zona de carga -->
        <div class="upload-zone" id="uploadZone">
            <h2>üìÅ Arrastra im√°genes aqu√≠ o haz clic para seleccionar</h2>
            <p>Soporta JPG, PNG, WebP, GIF y m√°s formatos</p>
            <label class="btn btn-primary">
                Seleccionar Im√°genes
                <input type="file" id="fileInput" multiple accept="image/*">
            </label>
            <div class="upload-limits">
                <strong>L√≠mites:</strong> M√°x. 50 MB por imagen | Advertencia si >5 im√°genes o >200 MB total<br>
                <em>üí° Mejor experiencia en Chrome/Firefox de escritorio. Safari/m√≥vil puede limitar tama√±os grandes.</em>
            </div>
        </div>

        <!-- Alertas -->
        <div id="alertsContainer"></div>

        <!-- Controles globales (aparecen cuando hay im√°genes) -->
        <div class="global-controls hidden" id="globalControls">
            <div class="global-left">
                <div class="control-group">
                    <label>Dividir Horizontalmente:</label>
                    <input type="number" id="globalRows" value="1" min="1" max="50">
                </div>
                <div class="control-group">
                    <label>Dividir Verticalmente:</label>
                    <input type="number" id="globalCols" value="1" min="1" max="50">
                </div>
                <button class="btn btn-primary btn-small" id="applyGlobalBtn">Aplicar a todas</button>
            </div>
            <div class="global-right">
                <button class="btn btn-success" id="downloadAllBtn">üì¶ Descargar Todo (ZIP)</button>
                <button class="btn btn-danger btn-small" id="clearAllBtn">üóëÔ∏è Limpiar todo</button>
            </div>
        </div>

        <!-- Contenedor de im√°genes -->
        <div id="images-container"></div>
    </main>

    <!-- ========== FOOTER ========== -->
    <footer>
        <p>Divisor de Im√°genes Gratuito | 100% privado - Todo se procesa en tu navegador | Sin servidores externos</p>
        <p>Compatible con Chrome, Firefox, Edge y Safari (escritorio y m√≥vil)</p>
    </footer>

    <!-- ========== MODAL TUTORIAL ========== -->
    <div class="modal-overlay" id="tutorialModal">
        <div class="modal">
            <h2>üëã Bienvenido al Divisor de Im√°genes</h2>
            <p>Esta herramienta te permite dividir m√∫ltiples im√°genes de forma r√°pida y privada.</p>
            
            <h3>üìå C√≥mo usar:</h3>
            <ul>
                <li><strong>Cargar:</strong> Arrastra im√°genes o usa el bot√≥n de selecci√≥n.</li>
                <li><strong>Configurar:</strong> Ajusta "Dividir Horizontalmente" y "Dividir Verticalmente" para cada imagen.</li>
                <li><strong>Ajustar:</strong> Arrastra las l√≠neas divisoras para ajustes precisos (funciona en m√≥vil).</li>
                <li><strong>Eliminar l√≠nea:</strong> Toca/haz clic en el bot√≥n ‚úï rojo de cada l√≠nea.</li>
                <li><strong>Global:</strong> Usa "Aplicar a todas" para copiar la configuraci√≥n a todas las im√°genes.</li>
                <li><strong>Descargar:</strong> Descarga partes individuales o todo en ZIP.</li>
            </ul>

            <h3>üé® Colores de l√≠neas:</h3>
            <ul>
                <li><span style="color: #2563eb; font-weight: bold;">‚ñ† Azul</span> = L√≠neas verticales (divisi√≥n vertical)</li>
                <li><span style="color: #dc2626; font-weight: bold;">‚ñ† Rojo</span> = L√≠neas horizontales (divisi√≥n horizontal)</li>
            </ul>

            <h3>‚ö° Atajos (escritorio):</h3>
            <ul>
                <li><strong>Ctrl+Z:</strong> Deshacer</li>
                <li><strong>Ctrl+Y:</strong> Rehacer</li>
            </ul>

            <button class="btn btn-primary close-btn" id="closeTutorial">¬°Entendido! Empezar</button>
        </div>
    </div>

    <!-- ========== JAVASCRIPT ========== -->
    <script>
    /**
     * =========================================================================
     * DIVISOR DE IM√ÅGENES AVANZADO - VERSI√ìN CORREGIDA
     * =========================================================================
     * 
     * CORRECCIONES APLICADAS:
     * 1. Soporte t√°ctil completo para arrastrar l√≠neas en m√≥vil
     * 2. C√°lculo de posiciones 100% preciso usando getBoundingClientRect
     * 3. Etiquetas m√°s claras: "Dividir Horizontalmente/Verticalmente"
     * 4. Im√°genes centradas en el contenedor
     * 
     * ARQUITECTURA:
     * - Cada imagen tiene su propio estado independiente
     * - Las l√≠neas usan posiciones en % para precisi√≥n perfecta
     * - Sistema de undo/redo por imagen
     * - ZIP generado 100% client-side
     * 
     * =========================================================================
     */

    // ========== ESTADO GLOBAL ==========
    const state = {
        images: new Map(),
        nextId: 1,
        activeImageId: null,
        tutorialShown: localStorage.getItem('tutorialShown') === 'true',
        // Para tracking de drag activo
        activeDrag: null
    };

    // ========== CONSTANTES ==========
    const MAX_FILE_SIZE = 50 * 1024 * 1024;
    const WARN_FILE_COUNT = 5;
    const WARN_TOTAL_SIZE = 200 * 1024 * 1024;
    const MAX_DIMENSION = 30000;
    const PREVIEW_MAX_WIDTH = 1200;
    const PREVIEW_MAX_HEIGHT = 800;

    // ========== INICIALIZACI√ìN ==========
    document.addEventListener('DOMContentLoaded', () => {
        initTheme();
        initUpload();
        initGlobalControls();
        initTutorial();
        initKeyboardShortcuts();
        initGlobalTouchHandlers();
    });

    /**
     * MANEJADORES GLOBALES DE TOUCH/MOUSE
     * ====================================
     * Para que el arrastre funcione correctamente en m√≥vil,
     * necesitamos manejar los eventos a nivel de documento.
     */
    function initGlobalTouchHandlers() {
        // Prevenir scroll durante drag
        document.addEventListener('touchmove', (e) => {
            if (state.activeDrag) {
                e.preventDefault();
            }
        }, { passive: false });

        // Terminar drag en cualquier touchend/mouseup
        document.addEventListener('touchend', handleGlobalDragEnd);
        document.addEventListener('touchcancel', handleGlobalDragEnd);
        document.addEventListener('mouseup', handleGlobalDragEnd);

        // Mover l√≠nea durante drag
        document.addEventListener('touchmove', handleGlobalDragMove, { passive: false });
        document.addEventListener('mousemove', handleGlobalDragMove);
    }

    function handleGlobalDragEnd() {
        if (state.activeDrag) {
            const { imageData, line } = state.activeDrag;
            line.classList.remove('dragging');
            saveToHistory(imageData);
            state.activeDrag = null;
        }
    }

    /**
     * MANEJO DEL MOVIMIENTO DE L√çNEA - PRECISI√ìN 100%
     * ================================================
     * El c√°lculo usa getBoundingClientRect del CANVAS (no del container)
     * para obtener las coordenadas exactas del √°rea de la imagen.
     */
    function handleGlobalDragMove(e) {
        if (!state.activeDrag) return;

        const { imageData, type, index, line } = state.activeDrag;
        
        // Obtener posici√≥n del puntero (touch o mouse)
        let clientX, clientY;
        if (e.touches && e.touches.length > 0) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }

        // IMPORTANTE: Usar el canvas como referencia, no el container
        const canvas = imageData.element.querySelector('.preview-canvas');
        const rect = canvas.getBoundingClientRect();

        let newPercent;

        if (type === 'vertical') {
            // Calcular posici√≥n X relativa al canvas
            const relativeX = clientX - rect.left;
            newPercent = (relativeX / rect.width) * 100;
        } else {
            // Calcular posici√≥n Y relativa al canvas
            const relativeY = clientY - rect.top;
            newPercent = (relativeY / rect.height) * 100;
        }

        // Limitar entre 1% y 99%
        newPercent = Math.max(1, Math.min(99, newPercent));

        // Actualizar posici√≥n
        if (type === 'vertical') {
            line.style.left = `${newPercent}%`;
            imageData.verticalLines[index] = newPercent;
        } else {
            line.style.top = `${newPercent}%`;
            imageData.horizontalLines[index] = newPercent;
        }

        // Actualizar preview en tiempo real
        updatePartsPreview(imageData);
    }

    // ========== TEMA ==========
    function initTheme() {
        const saved = localStorage.getItem('theme');
        if (saved) {
            document.documentElement.setAttribute('data-theme', saved);
            updateThemeButtons(saved);
        }

        document.getElementById('themeAuto').addEventListener('click', () => setTheme('auto'));
        document.getElementById('themeLight').addEventListener('click', () => setTheme('light'));
        document.getElementById('themeDark').addEventListener('click', () => setTheme('dark'));
    }

    function setTheme(theme) {
        if (theme === 'auto') {
            document.documentElement.removeAttribute('data-theme');
            localStorage.removeItem('theme');
        } else {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }
        updateThemeButtons(theme);
    }

    function updateThemeButtons(theme) {
        document.querySelectorAll('.theme-toggle button').forEach(btn => btn.classList.remove('active'));
        if (theme === 'auto' || !theme) {
            document.getElementById('themeAuto').classList.add('active');
        } else if (theme === 'light') {
            document.getElementById('themeLight').classList.add('active');
        } else {
            document.getElementById('themeDark').classList.add('active');
        }
    }

    // ========== TUTORIAL ==========
    function initTutorial() {
        const modal = document.getElementById('tutorialModal');
        const closeBtn = document.getElementById('closeTutorial');
        const helpBtn = document.getElementById('helpBtn');

        if (state.tutorialShown) {
            modal.classList.add('hidden');
        }

        closeBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            localStorage.setItem('tutorialShown', 'true');
            state.tutorialShown = true;
        });

        helpBtn.addEventListener('click', () => {
            modal.classList.remove('hidden');
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });
    }

    // ========== UPLOAD ==========
    function initUpload() {
        const zone = document.getElementById('uploadZone');
        const input = document.getElementById('fileInput');

        zone.addEventListener('dragover', (e) => {
            e.preventDefault();
            zone.classList.add('dragover');
        });

        zone.addEventListener('dragleave', () => {
            zone.classList.remove('dragover');
        });

        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        input.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            input.value = '';
        });
    }

    async function handleFiles(fileList) {
        const files = Array.from(fileList).filter(f => f.type.startsWith('image/'));
        
        if (files.length === 0) {
            showAlert('No se encontraron im√°genes v√°lidas', 'danger');
            return;
        }

        const totalSize = files.reduce((sum, f) => sum + f.size, 0);
        const oversizedFiles = files.filter(f => f.size > MAX_FILE_SIZE);

        if (oversizedFiles.length > 0) {
            showAlert(`${oversizedFiles.length} archivo(s) superan 50 MB y ser√°n omitidos`, 'danger');
        }

        if (files.length > WARN_FILE_COUNT) {
            showAlert(`Cargando ${files.length} im√°genes. Esto puede consumir mucha memoria.`, 'warning');
        }

        if (totalSize > WARN_TOTAL_SIZE) {
            showAlert(`Tama√±o total: ${(totalSize / 1024 / 1024).toFixed(1)} MB. Puede afectar el rendimiento.`, 'warning');
        }

        const validFiles = files.filter(f => f.size <= MAX_FILE_SIZE);
        
        for (const file of validFiles) {
            await loadImage(file);
        }

        updateGlobalControlsVisibility();
    }

    async function loadImage(file) {
        return new Promise((resolve) => {
            const img = new Image();
            const id = state.nextId++;

            img.onload = () => {
                if (img.width > MAX_DIMENSION || img.height > MAX_DIMENSION) {
                    showAlert(`"${file.name}" tiene dimensiones muy grandes (${img.width}x${img.height}).`, 'warning');
                }

                const imageData = {
                    id,
                    file,
                    name: file.name,
                    width: img.width,
                    height: img.height,
                    originalImage: img,
                    rows: 1,
                    cols: 1,
                    verticalLines: [],
                    horizontalLines: [],
                    zoom: 1,
                    pan: { x: 0, y: 0 },
                    history: [{ vertical: [], horizontal: [], rows: 1, cols: 1 }],
                    historyIndex: 0,
                    element: null
                };

                state.images.set(id, imageData);
                renderImageSection(imageData);
                resolve();
            };

            img.onerror = () => {
                showAlert(`Error al cargar "${file.name}"`, 'danger');
                resolve();
            };

            img.src = URL.createObjectURL(file);
        });
    }

    // ========== RENDERIZADO ==========
    function renderImageSection(imageData) {
        const container = document.getElementById('images-container');
        
        const section = document.createElement('div');
        section.className = 'image-section';
        section.dataset.imageId = imageData.id;
        
        // ETIQUETAS CAMBIADAS: "Dividir Horizontalmente" y "Dividir Verticalmente"
        section.innerHTML = `
            <div class="image-header">
                <div class="image-info">
                    <h3>${escapeHtml(imageData.name)}</h3>
                    <span class="dimensions">${imageData.width} √ó ${imageData.height} px</span>
                </div>
                <div class="image-controls">
                    <div class="control-group">
                        <label>Div. Horizontal:</label>
                        <input type="number" class="rows-input" value="${imageData.rows}" min="1" max="50" title="N√∫mero de partes horizontales">
                    </div>
                    <div class="control-group">
                        <label>Div. Vertical:</label>
                        <input type="number" class="cols-input" value="${imageData.cols}" min="1" max="50" title="N√∫mero de partes verticales">
                    </div>
                    <button class="btn btn-secondary btn-small apply-config-btn" title="Aplicar esta configuraci√≥n a todas">üìã A todas</button>
                    <div class="history-controls">
                        <button class="btn btn-secondary btn-small undo-btn" title="Deshacer">‚Ü©</button>
                        <button class="btn btn-secondary btn-small redo-btn" title="Rehacer">‚Ü™</button>
                    </div>
                    <div class="zoom-controls">
                        <button class="btn btn-secondary btn-small zoom-out-btn">‚àí</button>
                        <span class="zoom-level">100%</span>
                        <button class="btn btn-secondary btn-small zoom-in-btn">+</button>
                        <button class="btn btn-secondary btn-small zoom-fit-btn">Ajustar</button>
                    </div>
                    <button class="btn btn-danger btn-small remove-btn" title="Eliminar imagen">‚úï</button>
                </div>
            </div>
            <div class="preview-wrapper">
                <div class="preview-container" data-image-id="${imageData.id}">
                    <canvas class="preview-canvas"></canvas>
                </div>
                <div class="progress-overlay hidden">
                    <div class="spinner"></div>
                    <p>Procesando...</p>
                </div>
            </div>
            <div class="parts-preview">
                <h4>Vista previa de partes: <span class="parts-count">1 parte</span></h4>
                <div class="parts-grid"></div>
            </div>
            <div class="image-actions">
                <button class="btn btn-success download-zip-btn">üì¶ Descargar ZIP (esta imagen)</button>
            </div>
        `;

        container.appendChild(section);
        imageData.element = section;

        renderPreviewCanvas(imageData);
        setupImageEvents(imageData, section);
        setupLazyLoading(imageData, section);
    }

    function renderPreviewCanvas(imageData) {
        const canvas = imageData.element.querySelector('.preview-canvas');
        const ctx = canvas.getContext('2d');

        let scale = 1;
        if (imageData.width > PREVIEW_MAX_WIDTH) {
            scale = PREVIEW_MAX_WIDTH / imageData.width;
        }
        if (imageData.height * scale > PREVIEW_MAX_HEIGHT) {
            scale = PREVIEW_MAX_HEIGHT / imageData.height;
        }

        const displayWidth = Math.floor(imageData.width * scale);
        const displayHeight = Math.floor(imageData.height * scale);

        canvas.width = displayWidth;
        canvas.height = displayHeight;
        canvas.style.width = displayWidth + 'px';
        canvas.style.height = displayHeight + 'px';

        imageData.displayScale = scale;
        imageData.displayWidth = displayWidth;
        imageData.displayHeight = displayHeight;

        try {
            ctx.drawImage(imageData.originalImage, 0, 0, displayWidth, displayHeight);
        } catch (e) {
            console.error('Error al dibujar imagen:', e);
            showAlert(`Error al renderizar "${imageData.name}".`, 'danger');
        }

        renderLines(imageData);
        updatePartsPreview(imageData);
    }

    function setupImageEvents(imageData, section) {
        const rowsInput = section.querySelector('.rows-input');
        const colsInput = section.querySelector('.cols-input');
        const applyConfigBtn = section.querySelector('.apply-config-btn');
        const undoBtn = section.querySelector('.undo-btn');
        const redoBtn = section.querySelector('.redo-btn');
        const zoomInBtn = section.querySelector('.zoom-in-btn');
        const zoomOutBtn = section.querySelector('.zoom-out-btn');
        const zoomFitBtn = section.querySelector('.zoom-fit-btn');
        const removeBtn = section.querySelector('.remove-btn');
        const downloadZipBtn = section.querySelector('.download-zip-btn');

        /**
         * GENERACI√ìN AUTOM√ÅTICA DE L√çNEAS
         * Para N divisiones, necesitamos N-1 l√≠neas
         * Posiciones uniformes: 100/N, 200/N, ..., (N-1)*100/N
         */
        const updateLines = () => {
            const rows = parseInt(rowsInput.value) || 1;
            const cols = parseInt(colsInput.value) || 1;
            
            imageData.rows = Math.max(1, Math.min(50, rows));
            imageData.cols = Math.max(1, Math.min(50, cols));
            
            rowsInput.value = imageData.rows;
            colsInput.value = imageData.cols;

            // L√≠neas horizontales para divisi√≥n horizontal
            imageData.horizontalLines = [];
            for (let i = 1; i < imageData.rows; i++) {
                imageData.horizontalLines.push((i / imageData.rows) * 100);
            }

            // L√≠neas verticales para divisi√≥n vertical
            imageData.verticalLines = [];
            for (let i = 1; i < imageData.cols; i++) {
                imageData.verticalLines.push((i / imageData.cols) * 100);
            }

            saveToHistory(imageData);
            renderLines(imageData);
            updatePartsPreview(imageData);
        };

        rowsInput.addEventListener('change', updateLines);
        colsInput.addEventListener('change', updateLines);

        // Aplicar a todas
        applyConfigBtn.addEventListener('click', () => {
            state.images.forEach((otherImage) => {
                if (otherImage.id === imageData.id) return;

                otherImage.rows = imageData.rows;
                otherImage.cols = imageData.cols;
                otherImage.verticalLines = [...imageData.verticalLines];
                otherImage.horizontalLines = [...imageData.horizontalLines];

                const otherSection = otherImage.element;
                otherSection.querySelector('.rows-input').value = otherImage.rows;
                otherSection.querySelector('.cols-input').value = otherImage.cols;

                saveToHistory(otherImage);
                renderLines(otherImage);
                updatePartsPreview(otherImage);
            });

            showAlert('Configuraci√≥n aplicada a todas las im√°genes', 'info');
        });

        undoBtn.addEventListener('click', () => undo(imageData));
        redoBtn.addEventListener('click', () => redo(imageData));

        zoomInBtn.addEventListener('click', () => setZoom(imageData, imageData.zoom * 1.25));
        zoomOutBtn.addEventListener('click', () => setZoom(imageData, imageData.zoom / 1.25));
        zoomFitBtn.addEventListener('click', () => setZoom(imageData, 1));

        removeBtn.addEventListener('click', () => removeImage(imageData.id));
        downloadZipBtn.addEventListener('click', () => downloadImageZip(imageData));

        section.addEventListener('click', () => {
            state.activeImageId = imageData.id;
        });
    }

    /**
     * RENDERIZAR L√çNEAS DIVISORAS
     */
    function renderLines(imageData) {
        const container = imageData.element.querySelector('.preview-container');
        
        // Eliminar l√≠neas existentes
        container.querySelectorAll('.split-line').forEach(el => el.remove());

        // Renderizar l√≠neas verticales (azules)
        imageData.verticalLines.forEach((pos, index) => {
            const line = createLine('vertical', pos, imageData, index);
            container.appendChild(line);
        });

        // Renderizar l√≠neas horizontales (rojas)
        imageData.horizontalLines.forEach((pos, index) => {
            const line = createLine('horizontal', pos, imageData, index);
            container.appendChild(line);
        });
    }

    /**
     * CREAR L√çNEA ARRASTRABLE - COMPATIBLE CON TOUCH Y MOUSE
     * =======================================================
     * La l√≠nea usa posici√≥n en % para que sea independiente del zoom.
     * El √°rea de toque est√° expandida con ::before para mejor UX en m√≥vil.
     */
    function createLine(type, position, imageData, index) {
        const line = document.createElement('div');
        line.className = `split-line ${type}`;
        line.dataset.index = index;
        line.dataset.type = type;

        // Posici√≥n inicial precisa en %
        if (type === 'vertical') {
            line.style.left = `${position}%`;
        } else {
            line.style.top = `${position}%`;
        }

        // Bot√≥n de eliminar
        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'line-delete-btn';
        deleteBtn.innerHTML = '‚úï';
        deleteBtn.title = 'Eliminar l√≠nea';
        line.appendChild(deleteBtn);

        // Evento de eliminar (touch y click)
        const handleDelete = (e) => {
            e.preventDefault();
            e.stopPropagation();
            removeLine(imageData, type, index);
        };
        deleteBtn.addEventListener('click', handleDelete);
        deleteBtn.addEventListener('touchend', handleDelete);

        /**
         * INICIO DE ARRASTRE - TOUCH Y MOUSE
         */
        const startDrag = (e) => {
            // Ignorar si es el bot√≥n de eliminar
            if (e.target === deleteBtn) return;

            e.preventDefault();
            e.stopPropagation();

            line.classList.add('dragging');
            state.activeImageId = imageData.id;

            // Guardar estado de drag activo
            state.activeDrag = {
                imageData,
                type,
                index,
                line
            };
        };

        // Event listeners para iniciar drag
        line.addEventListener('mousedown', startDrag);
        line.addEventListener('touchstart', startDrag, { passive: false });

        return line;
    }

    /**
     * ELIMINAR L√çNEA
     */
    function removeLine(imageData, type, index) {
        if (type === 'vertical') {
            imageData.verticalLines.splice(index, 1);
            imageData.cols = imageData.verticalLines.length + 1;
            imageData.element.querySelector('.cols-input').value = imageData.cols;
        } else {
            imageData.horizontalLines.splice(index, 1);
            imageData.rows = imageData.horizontalLines.length + 1;
            imageData.element.querySelector('.rows-input').value = imageData.rows;
        }

        saveToHistory(imageData);
        renderLines(imageData);
        updatePartsPreview(imageData);
    }

    /**
     * ACTUALIZAR VISTA PREVIA DE PARTES
     */
    function updatePartsPreview(imageData) {
        const partsGrid = imageData.element.querySelector('.parts-grid');
        const partsCount = imageData.element.querySelector('.parts-count');
        
        partsGrid.innerHTML = '';

        const regions = calculateRegions(imageData);
        partsCount.textContent = `${regions.length} parte${regions.length !== 1 ? 's' : ''}`;

        regions.forEach((region, idx) => {
            const thumb = document.createElement('div');
            thumb.className = 'part-thumbnail';

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const thumbSize = 80;
            const aspectRatio = region.width / region.height;
            
            if (aspectRatio > 1) {
                canvas.width = thumbSize;
                canvas.height = Math.max(1, thumbSize / aspectRatio);
            } else {
                canvas.height = thumbSize;
                canvas.width = Math.max(1, thumbSize * aspectRatio);
            }

            try {
                ctx.drawImage(
                    imageData.originalImage,
                    region.x, region.y, region.width, region.height,
                    0, 0, canvas.width, canvas.height
                );
            } catch (e) {
                ctx.fillStyle = '#ccc';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            const label = document.createElement('div');
            label.className = 'part-label';
            label.textContent = `${region.row + 1}-${region.col + 1}`;

            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'download-part';
            downloadBtn.innerHTML = '‚¨á';
            downloadBtn.title = 'Descargar esta parte';
            downloadBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                downloadPart(imageData, region);
            });

            thumb.appendChild(canvas);
            thumb.appendChild(label);
            thumb.appendChild(downloadBtn);
            partsGrid.appendChild(thumb);
        });
    }

    /**
     * CALCULAR REGIONES DE CORTE - PRECISI√ìN 100%
     * ============================================
     * Las l√≠neas est√°n en % (0-100), convertimos a p√≠xeles
     * usando el tama√±o original de la imagen.
     */
    function calculateRegions(imageData) {
        const regions = [];
        
        // Ordenar l√≠neas y a√±adir bordes (0% y 100%)
        const vLines = [0, ...imageData.verticalLines.slice().sort((a, b) => a - b), 100];
        const hLines = [0, ...imageData.horizontalLines.slice().sort((a, b) => a - b), 100];

        for (let row = 0; row < hLines.length - 1; row++) {
            for (let col = 0; col < vLines.length - 1; col++) {
                // Convertir % a p√≠xeles con precisi√≥n
                const x = Math.round((vLines[col] / 100) * imageData.width);
                const y = Math.round((hLines[row] / 100) * imageData.height);
                const x2 = Math.round((vLines[col + 1] / 100) * imageData.width);
                const y2 = Math.round((hLines[row + 1] / 100) * imageData.height);
                
                const width = x2 - x;
                const height = y2 - y;

                if (width > 0 && height > 0) {
                    regions.push({ x, y, width, height, row, col });
                }
            }
        }

        return regions;
    }

    // ========== HISTORIAL ==========
    function saveToHistory(imageData) {
        imageData.history = imageData.history.slice(0, imageData.historyIndex + 1);
        
        imageData.history.push({
            vertical: [...imageData.verticalLines],
            horizontal: [...imageData.horizontalLines],
            rows: imageData.rows,
            cols: imageData.cols
        });
        
        imageData.historyIndex = imageData.history.length - 1;

        if (imageData.history.length > 50) {
            imageData.history.shift();
            imageData.historyIndex--;
        }
    }

    function undo(imageData) {
        if (imageData.historyIndex > 0) {
            imageData.historyIndex--;
            applyHistoryState(imageData);
        }
    }

    function redo(imageData) {
        if (imageData.historyIndex < imageData.history.length - 1) {
            imageData.historyIndex++;
            applyHistoryState(imageData);
        }
    }

    function applyHistoryState(imageData) {
        const histState = imageData.history[imageData.historyIndex];
        imageData.verticalLines = [...histState.vertical];
        imageData.horizontalLines = [...histState.horizontal];
        imageData.rows = histState.rows;
        imageData.cols = histState.cols;

        imageData.element.querySelector('.rows-input').value = imageData.rows;
        imageData.element.querySelector('.cols-input').value = imageData.cols;

        renderLines(imageData);
        updatePartsPreview(imageData);
    }

    // ========== ZOOM ==========
    function setZoom(imageData, newZoom) {
        imageData.zoom = Math.max(0.25, Math.min(4, newZoom));
        
        const canvas = imageData.element.querySelector('.preview-canvas');
        
        canvas.style.transform = `scale(${imageData.zoom})`;
        canvas.style.transformOrigin = 'top left';
        
        const zoomLevel = imageData.element.querySelector('.zoom-level');
        zoomLevel.textContent = `${Math.round(imageData.zoom * 100)}%`;
    }

    // ========== ELIMINAR IMAGEN ==========
    function removeImage(id) {
        const imageData = state.images.get(id);
        if (!imageData) return;

        if (imageData.originalImage && imageData.originalImage.src) {
            URL.revokeObjectURL(imageData.originalImage.src);
        }

        imageData.originalImage = null;
        imageData.history = null;

        if (imageData.element) {
            imageData.element.remove();
        }

        state.images.delete(id);
        updateGlobalControlsVisibility();
    }

    // ========== CONTROLES GLOBALES ==========
    function initGlobalControls() {
        const applyGlobalBtn = document.getElementById('applyGlobalBtn');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const globalRows = document.getElementById('globalRows');
        const globalCols = document.getElementById('globalCols');

        applyGlobalBtn.addEventListener('click', () => {
            const rows = parseInt(globalRows.value) || 1;
            const cols = parseInt(globalCols.value) || 1;

            state.images.forEach((imageData) => {
                imageData.rows = rows;
                imageData.cols = cols;

                imageData.horizontalLines = [];
                for (let i = 1; i < rows; i++) {
                    imageData.horizontalLines.push((i / rows) * 100);
                }

                imageData.verticalLines = [];
                for (let i = 1; i < cols; i++) {
                    imageData.verticalLines.push((i / cols) * 100);
                }

                imageData.element.querySelector('.rows-input').value = rows;
                imageData.element.querySelector('.cols-input').value = cols;

                saveToHistory(imageData);
                renderLines(imageData);
                updatePartsPreview(imageData);
            });

            showAlert(`Divisi√≥n ${rows}√ó${cols} aplicada a todas las im√°genes`, 'info');
        });

        downloadAllBtn.addEventListener('click', downloadAllZip);

        clearAllBtn.addEventListener('click', () => {
            if (confirm('¬øEliminar todas las im√°genes?')) {
                state.images.forEach((_, id) => removeImage(id));
            }
        });
    }

    function updateGlobalControlsVisibility() {
        const controls = document.getElementById('globalControls');
        controls.classList.toggle('hidden', state.images.size === 0);
    }

    // ========== LAZY LOADING ==========
    function setupLazyLoading(imageData, section) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // Imagen visible
                }
            });
        }, { threshold: 0.1 });

        observer.observe(section);
    }

    // ========== DESCARGAS ==========
    function downloadPart(imageData, region) {
        const canvas = document.createElement('canvas');
        canvas.width = region.width;
        canvas.height = region.height;
        const ctx = canvas.getContext('2d');

        try {
            ctx.drawImage(
                imageData.originalImage,
                region.x, region.y, region.width, region.height,
                0, 0, region.width, region.height
            );

            canvas.toBlob((blob) => {
                const baseName = imageData.name.replace(/\.[^/.]+$/, '');
                const filename = `${baseName}-parte-${region.row + 1}-${region.col + 1}.png`;
                downloadBlob(blob, filename);
            }, 'image/png');
        } catch (e) {
            showAlert('Error al generar la parte.', 'danger');
        }
    }

    async function downloadImageZip(imageData) {
        const overlay = imageData.element.querySelector('.progress-overlay');
        overlay.classList.remove('hidden');

        try {
            const regions = calculateRegions(imageData);
            const files = [];
            const baseName = imageData.name.replace(/\.[^/.]+$/, '');

            for (const region of regions) {
                const canvas = document.createElement('canvas');
                canvas.width = region.width;
                canvas.height = region.height;
                const ctx = canvas.getContext('2d');

                ctx.drawImage(
                    imageData.originalImage,
                    region.x, region.y, region.width, region.height,
                    0, 0, region.width, region.height
                );

                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                const arrayBuffer = await blob.arrayBuffer();
                
                files.push({
                    name: `${baseName}-parte-${region.row + 1}-${region.col + 1}.png`,
                    data: new Uint8Array(arrayBuffer)
                });
            }

            const zipBlob = createZip(files);
            downloadBlob(zipBlob, `${baseName}-partes.zip`);

        } catch (e) {
            console.error('Error generando ZIP:', e);
            showAlert('Error al generar el ZIP', 'danger');
        } finally {
            overlay.classList.add('hidden');
        }
    }

    async function downloadAllZip() {
        if (state.images.size === 0) return;

        showAlert('Generando ZIP de todas las im√°genes...', 'info');

        try {
            const files = [];
            let imageIndex = 1;

            for (const imageData of state.images.values()) {
                const regions = calculateRegions(imageData);
                const baseName = imageData.name.replace(/\.[^/.]+$/, '');

                for (const region of regions) {
                    const canvas = document.createElement('canvas');
                    canvas.width = region.width;
                    canvas.height = region.height;
                    const ctx = canvas.getContext('2d');

                    ctx.drawImage(
                        imageData.originalImage,
                        region.x, region.y, region.width, region.height,
                        0, 0, region.width, region.height
                    );

                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                    const arrayBuffer = await blob.arrayBuffer();

                    files.push({
                        name: `imagen${imageIndex}-${baseName}-parte-${region.row + 1}-${region.col + 1}.png`,
                        data: new Uint8Array(arrayBuffer)
                    });
                }
                imageIndex++;
            }

            const zipBlob = createZip(files);
            downloadBlob(zipBlob, `imagenes-divididas-${Date.now()}.zip`);

            showAlert('ZIP generado exitosamente', 'info');

        } catch (e) {
            console.error('Error generando ZIP global:', e);
            showAlert('Error al generar el ZIP', 'danger');
        }
    }

    /**
     * IMPLEMENTACI√ìN VANILLA DE ZIP
     */
    function createZip(files) {
        const localHeaders = [];
        const centralHeaders = [];
        let offset = 0;

        files.forEach(file => {
            const nameBytes = new TextEncoder().encode(file.name);
            const data = file.data;

            const localHeader = new Uint8Array(30 + nameBytes.length);
            const localView = new DataView(localHeader.buffer);

            localView.setUint32(0, 0x04034b50, true);
            localView.setUint16(4, 20, true);
            localView.setUint16(6, 0, true);
            localView.setUint16(8, 0, true);
            localView.setUint16(10, 0, true);
            localView.setUint16(12, 0, true);
            localView.setUint32(14, crc32(data), true);
            localView.setUint32(18, data.length, true);
            localView.setUint32(22, data.length, true);
            localView.setUint16(26, nameBytes.length, true);
            localView.setUint16(28, 0, true);

            localHeader.set(nameBytes, 30);
            localHeaders.push({ header: localHeader, data });

            const centralHeader = new Uint8Array(46 + nameBytes.length);
            const centralView = new DataView(centralHeader.buffer);

            centralView.setUint32(0, 0x02014b50, true);
            centralView.setUint16(4, 20, true);
            centralView.setUint16(6, 20, true);
            centralView.setUint16(8, 0, true);
            centralView.setUint16(10, 0, true);
            centralView.setUint16(12, 0, true);
            centralView.setUint16(14, 0, true);
            centralView.setUint32(16, crc32(data), true);
            centralView.setUint32(20, data.length, true);
            centralView.setUint32(24, data.length, true);
            centralView.setUint16(28, nameBytes.length, true);
            centralView.setUint16(30, 0, true);
            centralView.setUint16(32, 0, true);
            centralView.setUint16(34, 0, true);
            centralView.setUint16(36, 0, true);
            centralView.setUint32(38, 0, true);
            centralView.setUint32(42, offset, true);

            centralHeader.set(nameBytes, 46);
            centralHeaders.push(centralHeader);

            offset += localHeader.length + data.length;
        });

        const centralDirSize = centralHeaders.reduce((sum, h) => sum + h.length, 0);
        const centralDirOffset = offset;

        const endRecord = new Uint8Array(22);
        const endView = new DataView(endRecord.buffer);

        endView.setUint32(0, 0x06054b50, true);
        endView.setUint16(4, 0, true);
        endView.setUint16(6, 0, true);
        endView.setUint16(8, files.length, true);
        endView.setUint16(10, files.length, true);
        endView.setUint32(12, centralDirSize, true);
        endView.setUint32(16, centralDirOffset, true);
        endView.setUint16(20, 0, true);

        const totalSize = offset + centralDirSize + endRecord.length;
        const zipData = new Uint8Array(totalSize);
        let pos = 0;

        localHeaders.forEach(({ header, data }) => {
            zipData.set(header, pos);
            pos += header.length;
            zipData.set(data, pos);
            pos += data.length;
        });

        centralHeaders.forEach(header => {
            zipData.set(header, pos);
            pos += header.length;
        });

        zipData.set(endRecord, pos);

        return new Blob([zipData], { type: 'application/zip' });
    }

    function crc32(data) {
        let crc = 0xFFFFFFFF;
        const table = getCRC32Table();

        for (let i = 0; i < data.length; i++) {
            crc = (crc >>> 8) ^ table[(crc ^ data[i]) & 0xFF];
        }

        return (crc ^ 0xFFFFFFFF) >>> 0;
    }

    let crc32Table = null;
    function getCRC32Table() {
        if (crc32Table) return crc32Table;

        crc32Table = new Uint32Array(256);
        for (let i = 0; i < 256; i++) {
            let c = i;
            for (let j = 0; j < 8; j++) {
                c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
            }
            crc32Table[i] = c;
        }
        return crc32Table;
    }

    function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // ========== ALERTAS ==========
    function showAlert(message, type = 'info') {
        const container = document.getElementById('alertsContainer');
        
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;

        container.appendChild(alert);

        setTimeout(() => {
            alert.remove();
        }, 5000);
    }

    // ========== ATAJOS DE TECLADO ==========
    function initKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                if (state.activeImageId) {
                    const imageData = state.images.get(state.activeImageId);
                    if (imageData) undo(imageData);
                }
            }

            if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                e.preventDefault();
                if (state.activeImageId) {
                    const imageData = state.images.get(state.activeImageId);
                    if (imageData) redo(imageData);
                }
            }
        });
    }

    // ========== UTILIDADES ==========
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    </script>
</body>
</html>
